<html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Justin Good&apos;s blog" name="description" /><meta content="Jgood Blog" property="og:title" /><meta content="Jgood&apos;s blog" property="og:description" /><meta content="website" property="og:type" /><meta content="https://jgood.online" property="og:url" /><meta content="https://jgood.online/img/2023-05-28-og-image-robot-steps.png" property="og:image" /><title>Jgood Blog</title><link href="/css/output.css" rel="stylesheet" type="text/css" /><link href="/img/2023-06-03-vaporwave-wigle-favicon.png" rel="icon" /><link href="https://fonts.googleapis.com" rel="preconnect" /><link crossorigin="crossorigin" href="https://fonts.gstatic.com" rel="preconnect" /><link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;family=Schibsted+Grotesk:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel="stylesheet" /><link href="/css/prism-synthwave-84.css" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script><script crossorigin="anonymous" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async="async" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script></head><body class="container mx-auto bg-grey"><header><nav class="flex flex-row mb-8 justify-end w-full p-2"><a class="text-2xl font-bold mr-2 text-white no-underline grow" href="/"><span class="text-cyan font-grotesk">Justin</span><span class="text-green font-grotesk">Good</span></a><a class="text-xl mr-2" href="/now">now</a><a class="text-xl mr-2" href="/archive">archive</a><a class="text-xl mr-2" href="/rss.xml">feed</a></nav></header><main class="max-w-screen-lg mx-auto grid grid-cols-4 gap-4 p-4"><div class="col-span-4 md:col-span-3 w-full .md:w-3/4"><p class="text-white-900 italic">Read time: 7 mins</p><div><h1 id="htmx-search">HTMX Search</h1>
<h2 id="out-of-the-box">Out of the Box</h2>
<p>The <a href="https://htmx.org/examples/active-search/">htmx docs have
a basic example</a> of <em>active search</em>. It's inticing to have a
feature like that with just so few lines of declarative html. Let's look
at it real quick before we get into my more involved example.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode html"><code class="language-html"><span id="cb1-1"><a aria-hidden="true" href="#cb1-1" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">h3</span><span class="dt">&gt;</span></span>
<span id="cb1-2"><a aria-hidden="true" href="#cb1-2" tabindex="-1"></a>  Search Contacts</span>
<span id="cb1-3"><a aria-hidden="true" href="#cb1-3" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;htmx-indicator&quot;</span><span class="dt">&gt;</span></span>
<span id="cb1-4"><a aria-hidden="true" href="#cb1-4" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;/img/bars.svg&quot;</span><span class="dt">/&gt;</span> Searching...</span>
<span id="cb1-5"><a aria-hidden="true" href="#cb1-5" tabindex="-1"></a>   <span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb1-6"><a aria-hidden="true" href="#cb1-6" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">h3</span><span class="dt">&gt;</span></span>
<span id="cb1-7"><a aria-hidden="true" href="#cb1-7" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;form-control&quot;</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;search&quot;</span></span>
<span id="cb1-8"><a aria-hidden="true" href="#cb1-8" tabindex="-1"></a><span class="ot">       name</span><span class="op">=</span><span class="st">&quot;search&quot;</span><span class="ot"> placeholder</span><span class="op">=</span><span class="st">&quot;Begin Typing To Search Users...&quot;</span></span>
<span id="cb1-9"><a aria-hidden="true" href="#cb1-9" tabindex="-1"></a><span class="ot">       hx-post</span><span class="op">=</span><span class="st">&quot;/search&quot;</span></span>
<span id="cb1-10"><a aria-hidden="true" href="#cb1-10" tabindex="-1"></a><span class="ot">       hx-trigger</span><span class="op">=</span><span class="st">&quot;input changed delay:500ms, search&quot;</span></span>
<span id="cb1-11"><a aria-hidden="true" href="#cb1-11" tabindex="-1"></a><span class="ot">       hx-target</span><span class="op">=</span><span class="st">&quot;#search-results&quot;</span></span>
<span id="cb1-12"><a aria-hidden="true" href="#cb1-12" tabindex="-1"></a><span class="ot">       hx-indicator</span><span class="op">=</span><span class="st">&quot;.htmx-indicator&quot;</span><span class="dt">&gt;</span></span>
<span id="cb1-13"><a aria-hidden="true" href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a aria-hidden="true" href="#cb1-14" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">table</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;table&quot;</span><span class="dt">&gt;</span></span>
<span id="cb1-15"><a aria-hidden="true" href="#cb1-15" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">thead</span><span class="dt">&gt;</span></span>
<span id="cb1-16"><a aria-hidden="true" href="#cb1-16" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb1-17"><a aria-hidden="true" href="#cb1-17" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>First Name<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb1-18"><a aria-hidden="true" href="#cb1-18" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Last Name<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb1-19"><a aria-hidden="true" href="#cb1-19" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Email<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb1-20"><a aria-hidden="true" href="#cb1-20" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb1-21"><a aria-hidden="true" href="#cb1-21" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">thead</span><span class="dt">&gt;</span></span>
<span id="cb1-22"><a aria-hidden="true" href="#cb1-22" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">tbody</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;search-results&quot;</span><span class="dt">&gt;</span></span>
<span id="cb1-23"><a aria-hidden="true" href="#cb1-23" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">tbody</span><span class="dt">&gt;</span></span>
<span id="cb1-24"><a aria-hidden="true" href="#cb1-24" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">table</span><span class="dt">&gt;</span></span></code></pre></div>
<p>This is pretty straightforward. The input triggers on change and
posts to <code class="language-">/search</code> with it's value.</p>
<p>Then it pulls out the <code class="language-">#search-results</code> and replaces
<code class="language-">tbody</code> element with it.</p>
<p>Easy peasy â€¦ but what if you want to add a checkbox for some kind of
filter? What if you want the search inputs preserved in the url for
sharing/refreshing support?</p>
<p>That's the issue I ran into. That functionality complicates the
process but I think I've figured out a minimal way to accomplish this
while still staying true to <code class="language-">HATEOAS</code> and not adding too much
overhead.</p>
<h2 id="expanded">Expanded</h2>
<p>I'm building a personal insights app with Clojure, Biff, XTDB,
Tailwindcss, and HTMX. Part of that app includes habit tracking. This
implementation of typeahead search focuses on just the page that lists
the habits for editing and review.</p>
<p><img src="./../img/2023-11-26-habits-page.png" /></p>
<h3 id="other-inputs">Other Inputs</h3>
<p>For my habits tracker I needed to add a boolean attribute called
<code class="language-">sensitive</code>. This acts as a flag to hide the habit from
general views. To see sensitive habits the user has to explicitly
indicate they should present. I tend to demo my apps to friends and
sometimes I don't want <em>all</em> of my habits to be on display.</p>
<p>So now I have two inputs, a text input and a checkbox. In the future
I might add more inputs for different filtering options. So I need to
include all of that input data in a single request to the server.</p>
<p>The best way I could think to do that was with a form component. Here
is some code in Clojure/Hiccup that shows the form.
<code class="language-">biff/form</code> is a framework convenience that outputs
<code class="language-">[:form]</code> element with some magic for hidden elements and a
csrf token.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode clojure"><code class="language-clojure"><span id="cb2-1"><a aria-hidden="true" href="#cb2-1" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> habits-search-component </span>[{<span class="at">:keys</span> [sensitive search]}]</span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2" tabindex="-1"></a>  [<span class="at">:div.my-2</span></span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3" tabindex="-1"></a>   (biff/form</span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4" tabindex="-1"></a>    {<span class="at">:id</span>         <span class="st">&quot;habit-search&quot;</span></span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5" tabindex="-1"></a>     <span class="at">:hx-post</span>    <span class="st">&quot;/app/habits&quot;</span></span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6" tabindex="-1"></a>     <span class="at">:hx-swap</span>    <span class="st">&quot;outerHTML&quot;</span></span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7" tabindex="-1"></a>     <span class="at">:hx-trigger</span> <span class="st">&quot;search delay:500ms&quot;</span></span>
<span id="cb2-8"><a aria-hidden="true" href="#cb2-8" tabindex="-1"></a>     <span class="at">:hx-select</span>  <span class="st">&quot;#habits-list&quot;</span></span>
<span id="cb2-9"><a aria-hidden="true" href="#cb2-9" tabindex="-1"></a>     <span class="at">:hx-target</span>  <span class="st">&quot;#habits-list&quot;</span>}</span>
<span id="cb2-10"><a aria-hidden="true" href="#cb2-10" tabindex="-1"></a>    [<span class="at">:div.flex.flex-col.justify-center.my-6</span></span>
<span id="cb2-11"><a aria-hidden="true" href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a aria-hidden="true" href="#cb2-12" tabindex="-1"></a>     [<span class="at">:input.form-control.w-full.md:w-96.mb-2</span></span>
<span id="cb2-13"><a aria-hidden="true" href="#cb2-13" tabindex="-1"></a>      {<span class="at">:type</span>        <span class="st">&quot;search&quot;</span></span>
<span id="cb2-14"><a aria-hidden="true" href="#cb2-14" tabindex="-1"></a>       <span class="at">:name</span>        <span class="st">&quot;search&quot;</span></span>
<span id="cb2-15"><a aria-hidden="true" href="#cb2-15" tabindex="-1"></a>       <span class="at">:script</span>      <span class="st">&quot;on keyup htmx.trigger('#habit-search', 'search', {})&quot;</span></span>
<span id="cb2-16"><a aria-hidden="true" href="#cb2-16" tabindex="-1"></a>       <span class="at">:placeholder</span> <span class="st">&quot;Begin Typing To Search Habits...&quot;</span>}]</span>
<span id="cb2-17"><a aria-hidden="true" href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a aria-hidden="true" href="#cb2-18" tabindex="-1"></a>     [<span class="at">:div.flex.flex-row.justify-start.items-center</span></span>
<span id="cb2-19"><a aria-hidden="true" href="#cb2-19" tabindex="-1"></a>      [<span class="at">:label.mr-4</span> {<span class="at">:for</span> <span class="st">&quot;sensitive&quot;</span>} <span class="st">&quot;Sensitive&quot;</span>]</span>
<span id="cb2-20"><a aria-hidden="true" href="#cb2-20" tabindex="-1"></a>      [<span class="at">:input.rounded.mr-2</span></span>
<span id="cb2-21"><a aria-hidden="true" href="#cb2-21" tabindex="-1"></a>       {<span class="at">:type</span>         <span class="st">&quot;checkbox&quot;</span></span>
<span id="cb2-22"><a aria-hidden="true" href="#cb2-22" tabindex="-1"></a>        <span class="at">:name</span>         <span class="st">&quot;sensitive&quot;</span></span>
<span id="cb2-23"><a aria-hidden="true" href="#cb2-23" tabindex="-1"></a>        <span class="at">:script</span>       <span class="st">&quot;on change htmx.trigger('#habit-search', 'search', {})&quot;</span></span>
<span id="cb2-24"><a aria-hidden="true" href="#cb2-24" tabindex="-1"></a>        <span class="at">:autocomplete</span> <span class="st">&quot;off&quot;</span></span>
<span id="cb2-25"><a aria-hidden="true" href="#cb2-25" tabindex="-1"></a>        <span class="at">:checked</span>      sensitive}]]])])</span></code></pre></div>
<p>This works for keeping all the inputs bundled together with each
request. On any action the inputs fire off a custom event that triggers
the form. There is no submit button. The <code class="language-">:script</code> attribute
accomplishes this with a touch of <em>hyperscript</em>.</p>
<p>The habits page backend endpoint needs to also accept a post request
and utilize the input data to filter the results. In my backend I have
the same clojure function that serves the initial GET request also
server the POST request.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode clojure"><code class="language-clojure"><span id="cb3-1"><a aria-hidden="true" href="#cb3-1" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> habits-page</span></span>
<span id="cb3-2"><a aria-hidden="true" href="#cb3-2" tabindex="-1"></a>  <span class="st">&quot;Accepts GET and POST. POST is for search form.&quot;</span></span>
<span id="cb3-3"><a aria-hidden="true" href="#cb3-3" tabindex="-1"></a>  [{<span class="at">:keys</span> [session biff/db params]}]</span>
<span id="cb3-4"><a aria-hidden="true" href="#cb3-4" tabindex="-1"></a>  (<span class="kw">let</span> [user-id                        (<span class="at">:uid</span> session)</span>
<span id="cb3-5"><a aria-hidden="true" href="#cb3-5" tabindex="-1"></a>        {<span class="at">:user/keys</span> [email time-zone]} (xt/entity db user-id)</span>
<span id="cb3-6"><a aria-hidden="true" href="#cb3-6" tabindex="-1"></a>        habits                         (habits-query (pot/map-of db user-id))</span>
<span id="cb3-7"><a aria-hidden="true" href="#cb3-7" tabindex="-1"></a>        sensitive                      (some-&gt; params <span class="at">:sensitive</span> checkbox-true?)</span>
<span id="cb3-8"><a aria-hidden="true" href="#cb3-8" tabindex="-1"></a>        search                         (some-&gt; params <span class="at">:search</span> search-str-xform)]</span>
<span id="cb3-9"><a aria-hidden="true" href="#cb3-9" tabindex="-1"></a>    (ui/page</span>
<span id="cb3-10"><a aria-hidden="true" href="#cb3-10" tabindex="-1"></a>     {}</span>
<span id="cb3-11"><a aria-hidden="true" href="#cb3-11" tabindex="-1"></a>     [<span class="at">:div</span></span>
<span id="cb3-12"><a aria-hidden="true" href="#cb3-12" tabindex="-1"></a>      (header (pot/map-of email))</span>
<span id="cb3-13"><a aria-hidden="true" href="#cb3-13" tabindex="-1"></a>      [<span class="at">:button.bg-blue-500.hover:bg-blue-700.text-white.font-bold.py-2.px-4.rounded.w-full.md:w-96.mt-6</span></span>
<span id="cb3-14"><a aria-hidden="true" href="#cb3-14" tabindex="-1"></a>       <span class="co">;; </span><span class="al">TODO</span><span class="co"> not implemented yet</span></span>
<span id="cb3-15"><a aria-hidden="true" href="#cb3-15" tabindex="-1"></a>       <span class="st">&quot;Add habit&quot;</span>]</span>
<span id="cb3-16"><a aria-hidden="true" href="#cb3-16" tabindex="-1"></a>      (habits-search-component {<span class="at">:sensitive</span> sensitive <span class="at">:search</span> search})</span>
<span id="cb3-17"><a aria-hidden="true" href="#cb3-17" tabindex="-1"></a>      [<span class="at">:div</span> {<span class="at">:id</span> <span class="st">&quot;habits-list&quot;</span>}</span>
<span id="cb3-18"><a aria-hidden="true" href="#cb3-18" tabindex="-1"></a>       (<span class="kw">-&gt;&gt;</span> habits</span>
<span id="cb3-19"><a aria-hidden="true" href="#cb3-19" tabindex="-1"></a>            (<span class="kw">filter</span> (<span class="kw">fn</span> [{<span class="at">:habit/keys</span> [<span class="kw">name</span> notes]</span>
<span id="cb3-20"><a aria-hidden="true" href="#cb3-20" tabindex="-1"></a>                          this-habit-is-sensitive <span class="at">:habit/sensitive</span></span>
<span id="cb3-21"><a aria-hidden="true" href="#cb3-21" tabindex="-1"></a>                          id          <span class="at">:xt/id</span>}]</span>
<span id="cb3-22"><a aria-hidden="true" href="#cb3-22" tabindex="-1"></a>                      (<span class="kw">let</span> [matches-name  (str/includes? (str/lower-case <span class="kw">name</span>) search)</span>
<span id="cb3-23"><a aria-hidden="true" href="#cb3-23" tabindex="-1"></a>                            matches-notes (str/includes? (str/lower-case notes) search)]</span>
<span id="cb3-24"><a aria-hidden="true" href="#cb3-24" tabindex="-1"></a>                        (<span class="kw">and</span> (<span class="kw">or</span> sensitive</span>
<span id="cb3-25"><a aria-hidden="true" href="#cb3-25" tabindex="-1"></a>                                 (<span class="kw">-&gt;</span> id (<span class="kw">=</span> edit-id))</span>
<span id="cb3-26"><a aria-hidden="true" href="#cb3-26" tabindex="-1"></a>                                 (<span class="kw">not</span> this-habit-is-sensitive))</span>
<span id="cb3-27"><a aria-hidden="true" href="#cb3-27" tabindex="-1"></a>                             (<span class="kw">or</span> matches-name</span>
<span id="cb3-28"><a aria-hidden="true" href="#cb3-28" tabindex="-1"></a>                                 matches-notes)))))</span>
<span id="cb3-29"><a aria-hidden="true" href="#cb3-29" tabindex="-1"></a>            (<span class="kw">map</span> habits-list-item))]])))</span></code></pre></div>
<p>This works well, and we could stop there. However, I want one more
thing. I want the search paramters to be synced to query parameters.
Then if the user shares a link or refreshes the page the search results
are preserved.</p>
<h3 id="query-params-too">Query Params Too</h3>
<p>The most minimally viable way I could think to sync the state of
search to the query parameters of the url was to use a single javascript
function and to alter the backend a little bit.</p>
<p>Let's start with the js function. Biff has a static js file called
<code class="language-">main.js</code> in a resources directory that is for one off
functions like this. It has no build step of any kind and so far, this
is the only function I've added to that file.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="language-javascript"><span id="cb4-1"><a aria-hidden="true" href="#cb4-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">setURLParameter</span>(paramName<span class="op">,</span> value) {</span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;setting url param: &quot;</span><span class="op">,</span> paramName<span class="op">,</span> value)</span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3" tabindex="-1"></a>  <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span>)<span class="op">;</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4" tabindex="-1"></a>  <span class="co">// if the value is an empty string or null remove it otherwise set it</span></span>
<span id="cb4-5"><a aria-hidden="true" href="#cb4-5" tabindex="-1"></a>  <span class="cf">if</span> (value <span class="op">===</span> <span class="st">''</span> <span class="op">||</span> value <span class="op">===</span> <span class="kw">null</span>) {</span>
<span id="cb4-6"><a aria-hidden="true" href="#cb4-6" tabindex="-1"></a>    url<span class="op">.</span><span class="at">searchParams</span><span class="op">.</span><span class="fu">delete</span>(paramName)<span class="op">;</span></span>
<span id="cb4-7"><a aria-hidden="true" href="#cb4-7" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-8"><a aria-hidden="true" href="#cb4-8" tabindex="-1"></a>    url<span class="op">.</span><span class="at">searchParams</span><span class="op">.</span><span class="fu">set</span>(paramName<span class="op">,</span> value<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb4-9"><a aria-hidden="true" href="#cb4-9" tabindex="-1"></a>  }</span>
<span id="cb4-10"><a aria-hidden="true" href="#cb4-10" tabindex="-1"></a>  <span class="co">// keep the url bar in sync</span></span>
<span id="cb4-11"><a aria-hidden="true" href="#cb4-11" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">pushState</span>({}<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> url<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb4-12"><a aria-hidden="true" href="#cb4-12" tabindex="-1"></a>}</span></code></pre></div>
<p>All it does is take in a name and a value. It uses
<code class="language-">URL.searchParams</code> and <code class="language-">window.history.pushState</code>
to add and remove values and keep the browser in sync. Pretty
simple.</p>
<p>Now how does our search component call this? With <em>a smidge more
hypserscript</em>. Below is the full definition of my current search
component function. Notice the changes to the <code class="language-">:script</code>
attribute of each input.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode clojure"><code class="language-clojure"><span id="cb5-1"><a aria-hidden="true" href="#cb5-1" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> habits-search-component </span>[{<span class="at">:keys</span> [sensitive search]}]</span>
<span id="cb5-2"><a aria-hidden="true" href="#cb5-2" tabindex="-1"></a>  [<span class="at">:div.my-2</span></span>
<span id="cb5-3"><a aria-hidden="true" href="#cb5-3" tabindex="-1"></a>   (biff/form</span>
<span id="cb5-4"><a aria-hidden="true" href="#cb5-4" tabindex="-1"></a>    {<span class="at">:id</span>         <span class="st">&quot;habit-search&quot;</span></span>
<span id="cb5-5"><a aria-hidden="true" href="#cb5-5" tabindex="-1"></a>     <span class="at">:hx-post</span>    <span class="st">&quot;/app/habits&quot;</span></span>
<span id="cb5-6"><a aria-hidden="true" href="#cb5-6" tabindex="-1"></a>     <span class="at">:hx-swap</span>    <span class="st">&quot;outerHTML&quot;</span></span>
<span id="cb5-7"><a aria-hidden="true" href="#cb5-7" tabindex="-1"></a>     <span class="at">:hx-trigger</span> <span class="st">&quot;search delay:500ms&quot;</span></span>
<span id="cb5-8"><a aria-hidden="true" href="#cb5-8" tabindex="-1"></a>     <span class="at">:hx-select</span>  <span class="st">&quot;#habits-list&quot;</span></span>
<span id="cb5-9"><a aria-hidden="true" href="#cb5-9" tabindex="-1"></a>     <span class="at">:hx-target</span>  <span class="st">&quot;#habits-list&quot;</span>}</span>
<span id="cb5-10"><a aria-hidden="true" href="#cb5-10" tabindex="-1"></a>    [<span class="at">:div.flex.flex-col.justify-center.my-6</span></span>
<span id="cb5-11"><a aria-hidden="true" href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a aria-hidden="true" href="#cb5-12" tabindex="-1"></a>     [<span class="at">:input.form-control.w-full.md:w-96.mb-2</span></span>
<span id="cb5-13"><a aria-hidden="true" href="#cb5-13" tabindex="-1"></a>      (<span class="kw">merge</span> {<span class="at">:type</span>        <span class="st">&quot;search&quot;</span></span>
<span id="cb5-14"><a aria-hidden="true" href="#cb5-14" tabindex="-1"></a>              <span class="at">:name</span>        <span class="st">&quot;search&quot;</span></span>
<span id="cb5-15"><a aria-hidden="true" href="#cb5-15" tabindex="-1"></a>              <span class="at">:placeholder</span> <span class="st">&quot;Begin Typing To Search Habits...&quot;</span></span>
<span id="cb5-16"><a aria-hidden="true" href="#cb5-16" tabindex="-1"></a>              <span class="at">:script</span>      <span class="st">&quot;on keyup setURLParameter(me.name, me.value) then htmx.trigger('#habit-search', 'search', {})&quot;</span>}</span>
<span id="cb5-17"><a aria-hidden="true" href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a aria-hidden="true" href="#cb5-18" tabindex="-1"></a>             (<span class="kw">when</span> (<span class="kw">not</span> (str/blank? search))</span>
<span id="cb5-19"><a aria-hidden="true" href="#cb5-19" tabindex="-1"></a>               {<span class="at">:value</span> search}))]</span>
<span id="cb5-20"><a aria-hidden="true" href="#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a aria-hidden="true" href="#cb5-21" tabindex="-1"></a>     [<span class="at">:div.flex.flex-row.justify-start.items-center</span></span>
<span id="cb5-22"><a aria-hidden="true" href="#cb5-22" tabindex="-1"></a>      [<span class="at">:label.mr-4</span> {<span class="at">:for</span> <span class="st">&quot;sensitive&quot;</span>} <span class="st">&quot;Sensitive&quot;</span>]</span>
<span id="cb5-23"><a aria-hidden="true" href="#cb5-23" tabindex="-1"></a>      [<span class="at">:input.rounded.mr-2</span></span>
<span id="cb5-24"><a aria-hidden="true" href="#cb5-24" tabindex="-1"></a>       {<span class="at">:type</span>         <span class="st">&quot;checkbox&quot;</span></span>
<span id="cb5-25"><a aria-hidden="true" href="#cb5-25" tabindex="-1"></a>        <span class="at">:name</span>         <span class="st">&quot;sensitive&quot;</span></span>
<span id="cb5-26"><a aria-hidden="true" href="#cb5-26" tabindex="-1"></a>        <span class="at">:script</span>       <span class="st">&quot;on change setURLParameter(me.name, me.checked) then htmx.trigger('#habit-search', 'search', {})&quot;</span></span>
<span id="cb5-27"><a aria-hidden="true" href="#cb5-27" tabindex="-1"></a>        <span class="at">:autocomplete</span> <span class="st">&quot;off&quot;</span></span>
<span id="cb5-28"><a aria-hidden="true" href="#cb5-28" tabindex="-1"></a>        <span class="at">:checked</span>      sensitive}]]])])</span></code></pre></div>
<p>Now the <code class="language-">:script</code> attribute calls the
<code class="language-">setURLParameter</code> function with the name and value of the
input the attribute is on. <code class="language-">me</code> is a reserved symbol in
hyperscript for this purpose.</p>
<p>Changing the backend endpoint to accommodate query params and form
params was pretty straightfoward. Below is the full
<code class="language-">habits-page</code> component. The important change is within the
<code class="language-">let</code> block and the assignment of the <code class="language-">sensitive</code>
and <code class="language-">search</code> attributes.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode clojure"><code class="language-clojure"><span id="cb6-1"><a aria-hidden="true" href="#cb6-1" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> habits-page</span></span>
<span id="cb6-2"><a aria-hidden="true" href="#cb6-2" tabindex="-1"></a>  <span class="st">&quot;Accepts GET and POST. POST is for search form as body.&quot;</span></span>
<span id="cb6-3"><a aria-hidden="true" href="#cb6-3" tabindex="-1"></a>  [{<span class="at">:keys</span> [session biff/db params query-params]}]</span>
<span id="cb6-4"><a aria-hidden="true" href="#cb6-4" tabindex="-1"></a>  (<span class="kw">let</span> [user-id                        (<span class="at">:uid</span> session)</span>
<span id="cb6-5"><a aria-hidden="true" href="#cb6-5" tabindex="-1"></a>        {<span class="at">:user/keys</span> [email time-zone]} (xt/entity db user-id)</span>
<span id="cb6-6"><a aria-hidden="true" href="#cb6-6" tabindex="-1"></a>        habits                         (habits-query (pot/map-of db user-id))</span>
<span id="cb6-7"><a aria-hidden="true" href="#cb6-7" tabindex="-1"></a>        edit-id                        (some-&gt; params <span class="at">:edit</span> (java.util.UUID/fromString))</span>
<span id="cb6-8"><a aria-hidden="true" href="#cb6-8" tabindex="-1"></a>        sensitive                      (<span class="kw">or</span> (some-&gt; params <span class="at">:sensitive</span> checkbox-true?)</span>
<span id="cb6-9"><a aria-hidden="true" href="#cb6-9" tabindex="-1"></a>                                           (some-&gt; query-params <span class="at">:sensitive</span> checkbox-true?))</span>
<span id="cb6-10"><a aria-hidden="true" href="#cb6-10" tabindex="-1"></a>        search                         (<span class="kw">or</span> (some-&gt; params <span class="at">:search</span> search-str-xform)</span>
<span id="cb6-11"><a aria-hidden="true" href="#cb6-11" tabindex="-1"></a>                                           (some-&gt; query-params <span class="at">:search</span> search-str-xform)</span>
<span id="cb6-12"><a aria-hidden="true" href="#cb6-12" tabindex="-1"></a>                                           <span class="st">&quot;&quot;</span>)]</span>
<span id="cb6-13"><a aria-hidden="true" href="#cb6-13" tabindex="-1"></a>    (ui/page</span>
<span id="cb6-14"><a aria-hidden="true" href="#cb6-14" tabindex="-1"></a>     {}</span>
<span id="cb6-15"><a aria-hidden="true" href="#cb6-15" tabindex="-1"></a>     [<span class="at">:div</span></span>
<span id="cb6-16"><a aria-hidden="true" href="#cb6-16" tabindex="-1"></a>      (header (pot/map-of email))</span>
<span id="cb6-17"><a aria-hidden="true" href="#cb6-17" tabindex="-1"></a>      [<span class="at">:button.bg-blue-500.hover:bg-blue-700.text-white.font-bold.py-2.px-4.rounded.w-full.md:w-96.mt-6</span></span>
<span id="cb6-18"><a aria-hidden="true" href="#cb6-18" tabindex="-1"></a>       <span class="st">&quot;Add habit&quot;</span>]</span>
<span id="cb6-19"><a aria-hidden="true" href="#cb6-19" tabindex="-1"></a>      (habits-search-component {<span class="at">:sensitive</span> sensitive <span class="at">:search</span> search})</span>
<span id="cb6-20"><a aria-hidden="true" href="#cb6-20" tabindex="-1"></a>      [<span class="at">:div</span> {<span class="at">:id</span> <span class="st">&quot;habits-list&quot;</span>}</span>
<span id="cb6-21"><a aria-hidden="true" href="#cb6-21" tabindex="-1"></a>       (<span class="kw">-&gt;&gt;</span> habits</span>
<span id="cb6-22"><a aria-hidden="true" href="#cb6-22" tabindex="-1"></a>            (<span class="kw">filter</span> (<span class="kw">fn</span> [{<span class="at">:habit/keys</span> [<span class="kw">name</span> notes]</span>
<span id="cb6-23"><a aria-hidden="true" href="#cb6-23" tabindex="-1"></a>                          this-habit-is-sensitive <span class="at">:habit/sensitive</span></span>
<span id="cb6-24"><a aria-hidden="true" href="#cb6-24" tabindex="-1"></a>                          id          <span class="at">:xt/id</span>}]</span>
<span id="cb6-25"><a aria-hidden="true" href="#cb6-25" tabindex="-1"></a>                      (<span class="kw">let</span> [matches-name  (str/includes? (str/lower-case <span class="kw">name</span>) search)</span>
<span id="cb6-26"><a aria-hidden="true" href="#cb6-26" tabindex="-1"></a>                            matches-notes (str/includes? (str/lower-case notes) search)]</span>
<span id="cb6-27"><a aria-hidden="true" href="#cb6-27" tabindex="-1"></a>                        (<span class="kw">and</span> (<span class="kw">or</span> sensitive</span>
<span id="cb6-28"><a aria-hidden="true" href="#cb6-28" tabindex="-1"></a>                                 (<span class="kw">-&gt;</span> id (<span class="kw">=</span> edit-id))</span>
<span id="cb6-29"><a aria-hidden="true" href="#cb6-29" tabindex="-1"></a>                                 (<span class="kw">not</span> this-habit-is-sensitive))</span>
<span id="cb6-30"><a aria-hidden="true" href="#cb6-30" tabindex="-1"></a>                             (<span class="kw">or</span> matches-name</span>
<span id="cb6-31"><a aria-hidden="true" href="#cb6-31" tabindex="-1"></a>                                 matches-notes)))))</span>
<span id="cb6-32"><a aria-hidden="true" href="#cb6-32" tabindex="-1"></a>            (<span class="kw">map</span> (<span class="kw">fn</span> [z] (habit-list-item (<span class="kw">-&gt;</span> z (<span class="kw">assoc</span> <span class="at">:edit-id</span> edit-id))))))]])))</span></code></pre></div>
<p>Basically this changes is saying let the <code class="language-">search</code> and
<code class="language-">sensitive</code> symbols be the form params if present or the
query params. If neither is present then use a default value â€“ an empty
string and false in this case.</p>
<p>Now as the user types a search string or checks a box htmx will post
for new habits list content and also keep the url in sync. If the user
bookmarks the url and comes back to it the backend will act on those
search inputs and return the exact same page.</p>
<h2 id="overview">Overview</h2>
<p>To wrap it up here is a sequence diagram of how this flows.</p>
 <pre class="mermaid bg-white-900">  sequenceDiagram
    browser -&gt;&gt; server: GET /habits
    server -&gt;&gt; browser: Habbits page + scripts/stylesheets
    note over browser: Start typing in search box or press filter toggle
    browser --&gt; browser: setURLParameter(n,v) &amp; 'search' event
    browser -&gt;&gt; server: POST /habits
    server -&gt;&gt; browser: Habbits page (hx-target habits-list)
    browser --&gt; browser: replace habits-list
</pre>

<p>To recap this accomplishes the typeahead search functionality with
extra search inputs beyond just a string of text to search on. It also
keeps all search state encoded in the url to allow deep linking.</p>
</div></div><div class="hidden md:block md:h-full w-full .md:w-1/4"><div class="sticky top-0"><h4>Table of Contents</h4><nav id="table-of-contents">
  <ul>
  <li><a href="#htmx-search" id="toc-htmx-search">HTMX Search</a>
  <ul>
  <li><a href="#out-of-the-box" id="toc-out-of-the-box">Out of the
  Box</a></li>
  <li><a href="#expanded" id="toc-expanded">Expanded</a>
  <ul>
  <li><a href="#other-inputs" id="toc-other-inputs">Other
  Inputs</a></li>
  <li><a href="#query-params-too" id="toc-query-params-too">Query Params
  Too</a></li>
  </ul></li>
  <li><a href="#overview" id="toc-overview">Overview</a></li>
  </ul></li>
  </ul>
</nav></div></div></main><script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';</script></body></html>