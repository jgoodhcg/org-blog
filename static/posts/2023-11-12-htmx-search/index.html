<html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="Justin Good&apos;s blog" name="description" /><meta content="Jgood Blog" property="og:title" /><meta content="Jgood&apos;s blog" property="og:description" /><meta content="website" property="og:type" /><meta content="https://jgood.online" property="og:url" /><meta content="https://jgood.online/img/2023-05-28-og-image-robot-steps.png" property="og:image" /><title>Jgood Blog</title><link href="/css/output.css" rel="stylesheet" type="text/css" /><link href="/img/2023-06-03-vaporwave-wigle-favicon.png" rel="icon" /><link href="https://fonts.googleapis.com" rel="preconnect" /><link crossorigin="crossorigin" href="https://fonts.gstatic.com" rel="preconnect" /><link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;family=Schibsted+Grotesk:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel="stylesheet" /><link href="/css/prism-synthwave-84.css" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script><script crossorigin="anonymous" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async="async" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script></head><body class="container mx-auto bg-grey"><header><nav class="flex flex-row mb-8 justify-end w-full p-2"><a class="text-2xl font-bold mr-2 text-white no-underline grow" href="/"><span class="text-cyan font-grotesk">Justin</span><span class="text-green font-grotesk">Good</span></a><a class="text-xl mr-2" href="/now">now</a><a class="text-xl mr-2" href="/archive">archive</a><a class="text-xl mr-2" href="/rss.xml">feed</a></nav></header><main class="max-w-screen-lg mx-auto grid grid-cols-4 gap-4 p-4"><div class="col-span-4 md:col-span-3 w-full .md:w-3/4"><p class="text-white-900 italic">Read time: 3 mins</p><div><h1 id="typeahead-search-with-clojure-htmx">Typeahead Search with
Clojure + HTMX</h1>
<h2 id="intro">Intro</h2>
<h3 id="clojure-biff-xtdb-tailwindcss">Clojure, Biff, XTDB,
Tailwindcss</h3>
<h3 id="data-modeling">Data Modeling</h3>
<h3 id="intro-to-htmx">Intro to HTMX</h3>
<h3 id="api-overview">API Overview</h3>
<p>This snippet of code should describe the overall API. The only
requests relevant for this search example are the <code class="language-">GET</code> and
<code class="language-">POST</code> requests in the <code class="language-">/habits</code> endpoint.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode clojure"><code class="language-clojure"><span id="cb1-1"><a aria-hidden="true" href="#cb1-1" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> plugin</span></span>
<span id="cb1-2"><a aria-hidden="true" href="#cb1-2" tabindex="-1"></a>  {<span class="at">:static</span> {<span class="st">&quot;/about/&quot;</span> about-page}</span>
<span id="cb1-3"><a aria-hidden="true" href="#cb1-3" tabindex="-1"></a>   <span class="at">:routes</span> [<span class="st">&quot;/app&quot;</span> {<span class="at">:middleware</span> [mid/wrap-signed-in]}</span>
<span id="cb1-4"><a aria-hidden="true" href="#cb1-4" tabindex="-1"></a>            [<span class="st">&quot;&quot;</span> {<span class="at">:get</span> app}]</span>
<span id="cb1-5"><a aria-hidden="true" href="#cb1-5" tabindex="-1"></a>            [<span class="st">&quot;/db&quot;</span> {<span class="at">:get</span> db-viz}]</span>
<span id="cb1-6"><a aria-hidden="true" href="#cb1-6" tabindex="-1"></a>            [<span class="st">&quot;/habits&quot;</span> {<span class="at">:get</span>  habits-page</span>
<span id="cb1-7"><a aria-hidden="true" href="#cb1-7" tabindex="-1"></a>                        <span class="at">:post</span> habits-page}]</span>
<span id="cb1-8"><a aria-hidden="true" href="#cb1-8" tabindex="-1"></a>            [<span class="st">&quot;/habit/logs&quot;</span> {<span class="at">:get</span> habit-logs-page}]</span>
<span id="cb1-9"><a aria-hidden="true" href="#cb1-9" tabindex="-1"></a>            [<span class="st">&quot;/habit/add&quot;</span> {<span class="at">:post</span> habit-create!}]</span>
<span id="cb1-10"><a aria-hidden="true" href="#cb1-10" tabindex="-1"></a>            [<span class="st">&quot;/habit/log&quot;</span> {<span class="at">:post</span> habit-log-create!}]</span>
<span id="cb1-11"><a aria-hidden="true" href="#cb1-11" tabindex="-1"></a>            [<span class="st">&quot;/habit/edit&quot;</span> {<span class="at">:post</span> habit-edit!}]]})</span></code></pre></div>
<h2 id="search">Search</h2>
<h3 id="habits-page">Habits Page</h3>
<p>Here is all the code for the <code class="language-">/habits</code> page:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode clojure"><code class="language-clojure"><span id="cb2-1"><a aria-hidden="true" href="#cb2-1" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> habits-page</span></span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2" tabindex="-1"></a>  <span class="st">&quot;Accepts GET and POST. POST is for search form as body.&quot;</span></span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3" tabindex="-1"></a>  [{<span class="at">:keys</span> [session biff/db params query-params]}]</span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4" tabindex="-1"></a>  (<span class="kw">let</span> [user-id                        (<span class="at">:uid</span> session)</span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5" tabindex="-1"></a>        {<span class="at">:user/keys</span> [email time-zone]} (xt/entity db user-id)</span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6" tabindex="-1"></a>        habits                         (habits-query (pot/map-of db user-id))</span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7" tabindex="-1"></a>        edit-id                        (some-&gt; params <span class="at">:edit</span> (java.util.UUID/fromString))</span>
<span id="cb2-8"><a aria-hidden="true" href="#cb2-8" tabindex="-1"></a>        sensitive                      (<span class="kw">or</span> (some-&gt; params <span class="at">:sensitive</span> checkbox-true?)</span>
<span id="cb2-9"><a aria-hidden="true" href="#cb2-9" tabindex="-1"></a>                                           (some-&gt; query-params <span class="at">:sensitive</span> checkbox-true?))</span>
<span id="cb2-10"><a aria-hidden="true" href="#cb2-10" tabindex="-1"></a>        search                         (<span class="kw">or</span> (some-&gt; params <span class="at">:search</span> search-str-xform)</span>
<span id="cb2-11"><a aria-hidden="true" href="#cb2-11" tabindex="-1"></a>                                           (some-&gt; query-params <span class="at">:search</span> search-str-xform)</span>
<span id="cb2-12"><a aria-hidden="true" href="#cb2-12" tabindex="-1"></a>                                           <span class="st">&quot;&quot;</span>)]</span>
<span id="cb2-13"><a aria-hidden="true" href="#cb2-13" tabindex="-1"></a>    (ui/page</span>
<span id="cb2-14"><a aria-hidden="true" href="#cb2-14" tabindex="-1"></a>     {}</span>
<span id="cb2-15"><a aria-hidden="true" href="#cb2-15" tabindex="-1"></a>     [<span class="at">:div</span></span>
<span id="cb2-16"><a aria-hidden="true" href="#cb2-16" tabindex="-1"></a>      (header (pot/map-of email))</span>
<span id="cb2-17"><a aria-hidden="true" href="#cb2-17" tabindex="-1"></a>      [<span class="at">:button.bg-blue-500.hover:bg-blue-700.text-white.font-bold.py-2.px-4.rounded.w-full.md:w-96.mt-6</span></span>
<span id="cb2-18"><a aria-hidden="true" href="#cb2-18" tabindex="-1"></a>       <span class="st">&quot;Add habit&quot;</span>]</span>
<span id="cb2-19"><a aria-hidden="true" href="#cb2-19" tabindex="-1"></a>      (habit-search-component {<span class="at">:sensitive</span> sensitive <span class="at">:search</span> search})</span>
<span id="cb2-20"><a aria-hidden="true" href="#cb2-20" tabindex="-1"></a>      [<span class="at">:div</span> {<span class="at">:id</span> <span class="st">&quot;habits-list&quot;</span>}</span>
<span id="cb2-21"><a aria-hidden="true" href="#cb2-21" tabindex="-1"></a>       (<span class="kw">-&gt;&gt;</span> habits</span>
<span id="cb2-22"><a aria-hidden="true" href="#cb2-22" tabindex="-1"></a>            (<span class="kw">filter</span> (<span class="kw">fn</span> [{<span class="at">:habit/keys</span> [<span class="kw">name</span> notes]</span>
<span id="cb2-23"><a aria-hidden="true" href="#cb2-23" tabindex="-1"></a>                          this-habit-is-sensitive <span class="at">:habit/sensitive</span></span>
<span id="cb2-24"><a aria-hidden="true" href="#cb2-24" tabindex="-1"></a>                          id          <span class="at">:xt/id</span>}]</span>
<span id="cb2-25"><a aria-hidden="true" href="#cb2-25" tabindex="-1"></a>                      (<span class="kw">let</span> [matches-name  (str/includes? (str/lower-case <span class="kw">name</span>) search)</span>
<span id="cb2-26"><a aria-hidden="true" href="#cb2-26" tabindex="-1"></a>                            matches-notes (str/includes? (str/lower-case notes) search)]</span>
<span id="cb2-27"><a aria-hidden="true" href="#cb2-27" tabindex="-1"></a>                        (<span class="kw">and</span> (<span class="kw">or</span> sensitive</span>
<span id="cb2-28"><a aria-hidden="true" href="#cb2-28" tabindex="-1"></a>                                 (<span class="kw">-&gt;</span> id (<span class="kw">=</span> edit-id))</span>
<span id="cb2-29"><a aria-hidden="true" href="#cb2-29" tabindex="-1"></a>                                 (<span class="kw">not</span> this-habit-is-sensitive))</span>
<span id="cb2-30"><a aria-hidden="true" href="#cb2-30" tabindex="-1"></a>                             (<span class="kw">or</span> matches-name</span>
<span id="cb2-31"><a aria-hidden="true" href="#cb2-31" tabindex="-1"></a>                                 matches-notes)))))</span>
<span id="cb2-32"><a aria-hidden="true" href="#cb2-32" tabindex="-1"></a>            (<span class="kw">map</span> (<span class="kw">fn</span> [z] (habit-list-item (<span class="kw">-&gt;</span> z (<span class="kw">assoc</span> <span class="at">:edit-id</span> edit-id))))))]])))</span></code></pre></div>
<p>The first thing to notice is parameters for generating the habits
list. They either come from <code class="language-">params</code> or
<code class="language-">query-params</code>. If the request is a <code class="language-">GET</code> then the
parameters will be in <code class="language-">query-params</code>. If it's a
<code class="language-">POST</code> then they will be part of form submission and in the
body of the request. Body form parameters are in <code class="language-">params</code>.
There might be a better way to achieve this but I just decided to use
<code class="language-">params</code> first and fall back to
<code class="language-">query-params</code>.</p>
<p>The other thing to notice is how the full text search works. This is
a simple example that just utilizes <code class="language-">filter</code> and
<code class="language-">str/includes</code>. Replacing this with a more robust full text
search tool like ElasticSearch or Postgres full text search would not
change anything about the implementation with HTMX. Getting the
parameters from the client would still work the same way.</p>
<h3 id="search-component">Search component</h3>
<h3 id="htmx-targeting">HTMX Targeting</h3>
<h3 id="hateoas">HATEOAS</h3>
<h3 id="stateful-url">Stateful URL</h3>
</div></div><div class="hidden md:block md:h-full w-full .md:w-1/4"><div class="sticky top-0"><h4>Table of Contents</h4><nav id="table-of-contents">
  <ul>
  <li><a href="#typeahead-search-with-clojure-htmx" id="toc-typeahead-search-with-clojure-htmx">Typeahead Search with
  Clojure + HTMX</a>
  <ul>
  <li><a href="#intro" id="toc-intro">Intro</a>
  <ul>
  <li><a href="#clojure-biff-xtdb-tailwindcss" id="toc-clojure-biff-xtdb-tailwindcss">Clojure, Biff, XTDB,
  Tailwindcss</a></li>
  <li><a href="#data-modeling" id="toc-data-modeling">Data
  Modeling</a></li>
  <li><a href="#intro-to-htmx" id="toc-intro-to-htmx">Intro to
  HTMX</a></li>
  <li><a href="#api-overview" id="toc-api-overview">API
  Overview</a></li>
  </ul></li>
  <li><a href="#search" id="toc-search">Search</a>
  <ul>
  <li><a href="#habits-page" id="toc-habits-page">Habits Page</a></li>
  <li><a href="#search-component" id="toc-search-component">Search
  component</a></li>
  <li><a href="#htmx-targeting" id="toc-htmx-targeting">HTMX
  Targeting</a></li>
  <li><a href="#hateoas" id="toc-hateoas">HATEOAS</a></li>
  <li><a href="#stateful-url" id="toc-stateful-url">Stateful
  URL</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav></div></div></main></body></html>